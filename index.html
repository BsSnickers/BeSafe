<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>BeSafe - Карта преступлений</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/leaflet.css" />

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

  <style>
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: 'Arial', sans-serif;
    }

    .mobile-header {
    display: none; /* Скрываем мобильную шапку на компьютере */
}
    body {
        display: flex;
        height: 100vh;
        overflow: hidden;
    }
    .sidebar {
        width: 300px;
        background-color: #333333;
        color: white;
        padding: 20px;
        display: flex;
        flex-direction: column;
    }
    .logo {
        font-size: 28px;
        font-weight: bold;
        margin-bottom: 40px;
        color: white;
        text-decoration: none;
    }
    .form-group {
        margin-bottom: 20px;
    }
    .form-group label {
        display: block;
        margin-bottom: 8px;
        color: white;
    }
    select,
    input[type="date"],
    input[type="text"] {
        width: 100%;
        padding: 8px;
        border: 1px solid #ddd;
        border-radius: 4px;
        background-color: white;
        color: black;
    }
    .source-options {
        display: flex;
        flex-direction: column;
        gap: 10px;
    }
    .source-option {
        display: flex;
        align-items: center;
        gap: 8px;
    }
    .source-option input[type="checkbox"] {
        width: 16px;
        height: 16px;
    }
    .button {
        background-color: #B44C4C;
        color: white;
        padding: 12px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 16px;
        margin-top: 10px;
        transition: background-color 0.3s;
    }
    .button:hover {
        background-color: #983f3f;
    }
    .about-link {
        color: white;
        text-decoration: none;
        font-size: 14px;
        margin-top: auto;
    }
    .about-link:hover {
        text-decoration: underline;
    }
    .map-container {
        flex-grow: 1;
        position: relative;
        height: 100vh;
    }
    #map {
        width: 100%;
        height: 100%;
    }
    /* Обновлённые стили для верхних контролов */
    .top-controls {
        position: absolute;
        top: 10px;
        right: 10px;
        z-index: 1000;
        display: flex;
        gap: 10px;
        align-items: center;
    }
    .language-selector {
        background: white;
        border-radius: 4px;
        box-shadow: 0 1px 5px rgba(0,0,0,0.15);
        padding: 3px;
        margin-top: 10px;
    }
    .language-selector select {
        padding: 5px 10px;
        border: none;
        background: white;
        cursor: pointer;
    }
    .auth-buttons {
        display: flex;
        gap: 10px;
    }
    .auth-buttons .button {
        padding: 8px 12px;
        font-size: 14px;
    }
    .geolocation-button {
        position: absolute;
        bottom: 25px;
        right: 10px;
        z-index: 1000;
        background: white;
        border: 2px solid rgba(0, 0, 0, 0.2);
        border-radius: 4px;
        width: 34px;
        height: 34px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 1px 5px rgba(0, 0, 0, 0.15);
    }
    .geolocation-button:hover {
        background: #f4f4f4;
    }
    .geolocation-button svg {
        width: 20px;
        height: 20px;
        fill: #666;
    }
    @keyframes pulse {
        0% {
            transform: scale(0.5);
            opacity: 1;
        }
        100% {
            transform: scale(1.5);
            opacity: 0;
        }
    }
    .location-marker {
        width: 16px;
        height: 16px;
        background: #4285F4;
        border: 2px solid white;
        border-radius: 50%;
        box-shadow: 0 0 3px rgba(0, 0, 0, 0.3);
        position: relative;
    }
    .location-marker::after {
        content: '';
        display: block;
        width: 16px;
        height: 16px;
        background: rgba(66, 133, 244, 0.4);
        border-radius: 50%;
        position: absolute;
        top: -2px;
        left: -2px;
        animation: pulse 2s ease-out infinite;
    }
    .modal {
        display: none;
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        z-index: 1000;
        width: 400px;
        color: black;
    }
    #addMarkerModal {
        top: auto;
        left: auto;
        bottom: 20px;
        right: 20px;
        transform: none;
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        z-index: 1000;
        width: 400px;
        color: black;
    }
    .modal h3 {
        margin-bottom: 15px;
    }
    .modal-form input,
    .modal-form select,
    .modal-form textarea {
        width: 100%;
        margin-bottom: 15px;
        padding: 8px;
        border: 1px solid #ddd;
        border-radius: 4px;
    }
    .modal-form textarea {
        height: 100px;
        resize: vertical;
    }
    .modal-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        z-index: 999;
    }
    .location-option-buttons {
        display: flex;
        gap: 10px;
        margin-bottom: 15px;
    }
    #chooseLocationMap {
        width: 100%;
        height: 200px;
        display: none;
        margin-bottom: 15px;
    }
    @media (max-width: 768px) {
        body {
            flex-direction: column;
        }
        .map-container {
            height: 60vh;
        }
        .modal {
            width: 90%;
        }
        .top-controls {
            flex-direction: column;
            align-items: flex-end;
        }
    }
    .address-suggestions {
        position: absolute;
        background: white;
        border: 1px solid #ddd;
        border-radius: 4px;
        max-height: 150px;
        overflow-y: auto;
        z-index: 1001;
        width: 100%;
        display: none;
    }
    .address-suggestion {
        padding: 8px;
        cursor: pointer;
    }
    .address-suggestion:hover {
        background: #f0f0f0;
    }

    @media (max-width: 768px) {
        #addMarkerModal {
            max-height: 90vh;
            overflow-y: auto;
        }
    }

/* Новые стили для мобилок */
@media (max-width: 768px) {
  .sidebar {
    position: fixed;
    top: 0;
    left: -100%;
    width: 85%;
    height: 100vh;
    transition: 0.3s;
    z-index: 1001;
    padding-top: 50px;
  }
  
  .sidebar.active {
    left: 0;
  }

  .mobile-header {
    display: flex;
    align-items: center;
    padding: 12px;
    background: #333;
    color: white;
    position: fixed;
    top: 0;
    width: 100%;
    z-index: 1002; /* Увеличен z-index, чтобы кнопка была поверх сайдбара */
  }

  .hamburger {
    background: none;
    border: none;
    color: white;
    font-size: 24px;
    margin-right: 15px;
    cursor: pointer;
  }

  .mobile-title {
    font-size: 20px;
  }

  .map-container {
    height: 100vh;
    margin-top: 50px;
  }
}

@media (max-width: 768px) {
  .sidebar .logo {
    display: none;
  }
  
  .mobile-title {
    margin-left: 15px;
    font-size: 24px !important;
  }
}

@media (max-width: 768px) {
  .sidebar {
    padding-top: 70px; /* Увеличиваем верхний отступ */
  }

  .sidebar .form-group,
  .sidebar .button,
  .sidebar .about-link {
    margin-top: 15px; /* Добавляем отступы между элементами */
    margin-bottom: 15px;
  }

  .sidebar .button:first-of-type {
    margin-top: 20px; /* Дополнительный отступ для первой кнопки */
  }
}


@media (max-width: 768px) {

  
  .mobile-language {
    display: block !important;
    margin-top: 20px;
  }
  
  .language-selector select {
    width: 100%;
    padding: 8px;
  }
}


@media (max-width: 768px) {
  .leaflet-control-zoom {
    position: fixed !important;
    bottom: 70px;
    margin-bottom:320px;
    right: 10px;
    transition: none !important;
  }
}


@media (max-width: 768px) {
  .geolocation-button {
    bottom: 65px; /* Было 25px */
    position: fixed !important ;
  }
}

@media (max-width: 768px) {
  .mobile-language label {
    font-size: 14px;
    margin-bottom: 5px;
  }
  
  .mobile-language select {
    padding: 6px 8px !important;
    font-size: 14px;
    height: 36px;
  }
  
  .language-selector {
    width: 50%;
    margin-top: 10px;
  }
}

/* Скрыть мобильный селектор на десктопе */
@media (min-width: 769px) {
  .mobile-language {
    display: none !important;
  }
}

/* Скрыть десктопный селектор на мобилках */
@media (max-width: 768px) {
  .top-controls .language-selector {
    display: none !important;
  }
  
  .mobile-language {
    display: block !important; 
  }
}

/* Изменения для мобильных устройств */
@media (max-width: 768px) {
  /* Изменить порядок элементов верхних контролов: переключатель языка слева от кнопок авторизации */
  .top-controls {
    position: fixed;
    flex-direction: row;
    justify-content: space-between;
    align-items: center;
    top: 60px; /* изменено с 10px на 60px */
    right: 10px;
  }
  /* Гарантировать отображение переключателя языков в верхних контролах */
  .top-controls .language-selector {
    display: block !important;
  }
  /* Скрыть мобильный переключатель в сайдбаре */
  .mobile-language {
    display: none !important;
  }
  /* Зафиксировать положение кнопок при зуме */
  .top-controls .auth-buttons .button,
  .top-controls .language-selector select {
    transform-origin: center;
    transition: none;
  }
}

/* Центрирование модального окна добавления меток на мобильных устройствах */
@media (max-width: 768px) {
  #addMarkerModal {
    top: 50%;
    left: 50%;
    bottom: auto;
    right: auto;
    transform: translate(-50%, -50%);
    width: 90%;
    max-width: 400px;
  }
}

#useMyLocation {
  margin-bottom: 10px; /* Добавляет отступ снизу для отделения от поля даты */
}
</style>
</head>
<body>
    <div class="sidebar">
        <a href="#" class="logo">BeSafe</a>
        <div class="form-group">
          <label data-lang="crimeType">Тип преступления</label>
          <select id="crimeTypeFilter">
            <option value="all" data-lang="allTypes">Все типы</option>
            <option value="theft" data-lang="theft">Кража</option>
            <option value="violence" data-lang="violence">Насилие</option>
            <option value="fraud" data-lang="fraud">Мошенничество</option>
            <option value="robbery" data-lang="robbery">Грабеж</option>
            <option value="banditry" data-lang="banditry">Разбой</option>
            <option value="vehicleTheft" data-lang="vehicleTheft">Угон транспортного средства</option>
            <option value="vandalism" data-lang="vandalism">Вандализм</option>
            <option value="drugTrafficking" data-lang="drugTrafficking">Наркоторговля</option>
            <option value="hooliganism" data-lang="hooliganism">Хулиганство</option>
            <option value="roadAccident" data-lang="roadAccident">ДТП</option>
          </select>
        </div>
        <div class="form-group">
          <label data-lang="period">Период</label>
          <input type="date" id="startDate" placeholder="От" style="margin-bottom: 15px;" />
          <input type="date" id="endDate" placeholder="До" />
        </div>
        <div class="form-group">
          <label data-lang="source">Источник</label>
          <div class="source-options">
            <div class="source-option">
              <input type="checkbox" id="official" checked />
              <label for="official" data-lang="official">Официальный</label>
            </div>
            <div class="source-option">
              <input type="checkbox" id="unofficial" checked />
              <label for="unofficial" data-lang="unofficial">Неофициальный</label>
            </div>
          </div>
        </div>

        <button class="button" onclick="window.open('https://wa.me/+996999132667')" style="background-color: #25D366; margin-top: 10px;" data-lang="urgentContact">Срочная связь</button>
        <button class="button" onclick="handleAddMarker()" data-lang="reportCrime">Сообщить о преступлении</button>
        <button class="button" onclick="showAnalyticsModal()" data-lang="analytics">Аналитика</button>
        <a href="about.html" class="about-link" data-lang="aboutProject">О проекте</a>
        <div class="form-group mobile-language" style="display: none;">
            <label data-lang="language">Язык</label>
            <select id="mobileLanguageSelect" onchange="changeLanguage(this.value)" class="language-selector">
              <option value="ru">Русский</option>
              <option value="en">English</option>
              <option value="ky">Кыргызча</option>
            </select>
          </div>
      </div>
 
    
      <div class="map-container">
        <!-- Обновлённый блок управления -->
        <div class="top-controls">
          <div class="language-selector">
            <select id="languageSelect" onchange="changeLanguage(this.value)">
              <option value="ru">Русский</option>
              <option value="en">English</option>
              <option value="ky">Кыргызча</option>
            </select>
          </div>
          
          <div class="auth-buttons">
            <button id="signInButton" class="button" style="display: none;" data-lang="signIn">Войти через Google</button>
            <button id="signOutButton" class="button" style="display: none;" data-lang="signOut">Выйти</button>
          </div>
          <!-- Новая кнопка переключения между маркерами и тепловой картой -->
          <button id="toggleHeatmap" class="button" style="margin-left:10px;">Тепловая карта</button>
        </div>
    
        <button class="geolocation-button" onclick="getCurrentLocation()" title="Моё местоположение">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M12 8c-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4-1.79-4-4-4zm8.94 3c-.46-4.17-3.77-7.48-7.94-7.94V1h-2v2.06C6.83 3.52 3.52 6.83 3.06 11H1v2h2.06c.46 4.17 3.77 7.48 7.94 7.94V23h2v-2.06c4.17-.46 7.48-3.77 7.94-7.94H23v-2h-2.06zM12 19c-3.87 0-7-3.13-7-7s3.13-7 7-7 7 3.13-7-7-7 3.13-7-7z"/>
          </svg>
        </button>
        <div id="map"></div>
      </div>
    
      <!-- Модальное окно добавления метки -->
      <div class="modal" id="addMarkerModal">
        <h3 data-lang="addMarker">Добавить метку</h3>
        <form class="modal-form">
          <select id="crimeType" required>
            <option value="" data-lang="selectCrimeType">Выберите тип преступления</option>
            <option value="theft" data-lang="theft">Кража</option>
            <option value="violence" data-lang="violence">Насилие</option>
            <option value="fraud" data-lang="fraud">Мошенничество</option>
            <option value="robbery" data-lang="robbery">Грабеж</option>
            <option value="banditry" data-lang="banditry">Разбой</option>
            <option value="vehicleTheft" data-lang="vehicleTheft">Угон транспортного средства</option>
            <option value="vandalism" data-lang="vandalism">Вандализм</option>
            <option value="drugTrafficking" data-lang="drugTrafficking">Наркоторговля</option>
            <option value="hooliganism" data-lang="hooliganism">Хулиганство</option>
            <option value="roadAccident" data-lang="roadAccident">ДТП</option>
          </select>
          <div class="form-group">
            <label data-lang="addressMethod">Способ указания адреса</label>
            <div class="location-option-buttons">
              <button type="button" class="button" id="manualAddressBtn" data-lang="manualAddress">Вписать адрес вручную</button>
              <button type="button" class="button" id="mapAddressBtn" data-lang="mapAddress">Указать на карте</button>
            </div>
          </div>
          <div id="chooseLocationMap"></div>
          <div style="position: relative;">
            <input type="text" id="address" data-lang-placeholder="addressPlaceholder" placeholder="Адрес" />
            <div class="address-suggestions" id="addressSuggestions"></div>
            <!-- Новая кнопка для получения текущего местоположения -->
            <button type="button" class="button" id="useMyLocation" data-lang="myLocation">Мое местоположение</button>
          </div>
          <input type="date" id="date" data-lang-placeholder="datePlaceholder" placeholder="Дата происшествия" />
          <textarea id="description" data-lang-placeholder="descriptionPlaceholder" placeholder="Описание инцидента"></textarea>
          <button type="submit" class="button" data-lang="add">Добавить</button>
          <button type="button" class="button" style="background: #666;" onclick="hideModal('addMarkerModal')" data-lang="cancel">Отмена</button>
        </form>
      </div>

      <!-- Новое модальное окно для "Аналитика" -->
      <div class="modal" id="analyticsModal" style="width:80%; max-width:800px; max-height:80vh; overflow-y:auto;">
        <h3 data-lang="analytics">Аналитика</h3>
        <button class="button" onclick="hideAnalyticsModal()" data-lang="cancel" style="margin:10px;">Отмена</button>
        <div style="margin-bottom:10px; text-align:center;">
          <select id="recentFilterSelect">
            <option value="all">Все</option>
            <option value="theft" data-lang="theft">Кража</option>
            <option value="violence" data-lang="violence">Насилие</option>
            <option value="fraud" data-lang="fraud">Мошенничество</option>
            <option value="robbery" data-lang="robbery">Грабеж</option>
            <option value="banditry" data-lang="banditry">Разбой</option>
            <option value="vehicleTheft" data-lang="vehicleTheft">Угон транспортного средства</option>
            <option value="vandalism" data-lang="vandalism">Вандализм</option>
            <option value="drugTrafficking" data-lang="drugTrafficking">Наркоторговля</option>
            <option value="hooliganism" data-lang="hooliganism">Хулиганство</option>
            <option value="roadAccident" data-lang="roadAccident">ДТП</option>
          </select>
        </div>
        <div style="margin-bottom:10px; text-align:center;">
          <select id="timeFilterSelect">
            <option value="all">Все время</option>
            <option value="today">Сегодня</option>
            <option value="month">Этот месяц</option>
            <option value="year">Этот год</option>
          </select>
        </div>
        <p id="incidentCount" style="margin-bottom:10px;">Всего: 0</p>
        <div style="margin:10px auto; max-width:600px; height:300px;">
          <canvas id="analyticsChart"></canvas>
        </div>
        <div id="incidentList" style="max-height:400px; overflow-y:auto;"></div>
      </div>

      <div class="mobile-header">
        <button class="hamburger">☰</button>
        <h1 class="mobile-title">BeSafe</h1>
      </div>
    
      <!-- Общий overlay для модальных окон -->
      <div class="modal-overlay" id="modalOverlay"></div>
    
      <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/leaflet.js"></script>
      <!-- Добавляем Chart.js для динамических диаграмм -->
      <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
      <!-- Добавляем Leaflet.heat -->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.heat/0.2.0/leaflet-heat.js"></script>
<script>
  // Мультиязычность - словари
  const translations = {
    // Русский (базовый)
    'ru': {
      'crimeType': 'Тип преступления',
      'allTypes': 'Все типы',
      'theft': 'Кража',
      'violence': 'Насилие',
      'fraud': 'Мошенничество',
      'robbery': 'Грабеж',
      'banditry': 'Разбой',
      'vehicleTheft': 'Угон транспортного средства',
      'vandalism': 'Вандализм',
      'drugTrafficking': 'Наркоторговля',
      'hooliganism': 'Хулиганство',
      'roadAccident': 'ДТП',
      'period': 'Период',
      'source': 'Источник',
      'official': 'Официальный',
      'unofficial': 'Неофициальный',
      'urgentContact': 'Срочная связь',
      'reportCrime': 'Сообщить о преступлении',
      'recentIncidents': 'Недавние происшествия',
      'analytics': 'Аналитика',
      'aboutProject': 'О проекте',
      'signIn': 'Войти через Google',
      'signOut': 'Выйти',
      'addMarker': 'Добавить метку',
      'selectCrimeType': 'Выберите тип преступления',
      'addressMethod': 'Способ указания адреса',
      'manualAddress': 'Вписать адрес вручную',
      'mapAddress': 'Указать на карте',
      'add': 'Добавить',
      'cancel': 'Отмена',
      'addressPlaceholder': 'Адрес',
      'datePlaceholder': 'Дата происшествия',
      'descriptionPlaceholder': 'Описание инцидента',
      'addressNotFound': 'Адрес не найден',
      'markerAdded': 'Метка успешно добавлена!',
      'markerAddError': 'Произошла ошибка при добавлении метки. Пожалуйста, попробуйте еще раз.',
      'selectCrimeTypePrompt': 'Пожалуйста, выберите тип преступления!',
      'specifyAddress': 'Укажите адрес или выберите место на карте!',
      'specifyDate': 'Пожалуйста, укажите дату происшествия!',
      'specifyDescription': 'Пожалуйста, добавьте описание происшествия!',
      'deleteMarker': 'Удалить метку',
      'confirmDelete': 'Удалить метку?',
      'markerDeleted': 'Метка удалена',
      'deleteError': 'Ошибка удаления',
      'loginRequired': 'Войдите через Google',
      'geolocationNotSupported': 'Геолокация не поддерживается',
      'outOfBounds': 'Вы за пределами',
      'geolocationError': 'Ошибка геолокации',
      'loadError': 'Не удалось загрузить метки',
      'language': 'Язык',
      'mapLanguage': 'ru',
      'toggleToHeatmap': "Тепловая карта",
      'toggleToMarkers': "Маркер",
      'myLocation': "Мое местоположение"
    },
    
    // Английский
    'en': {
      'crimeType': 'Crime Type',
      'allTypes': 'All Types',
      'theft': 'Theft',
      'violence': 'Violence',
      'fraud': 'Fraud',
      'robbery': 'Robbery',
      'banditry': 'Banditry',
      'vehicleTheft': 'Vehicle Theft',
      'vandalism': 'Vandalism',
      'drugTrafficking': 'Drug Trafficking',
      'hooliganism': 'Hooliganism',
      'roadAccident': 'Road Accident',
      'period': 'Period',
      'source': 'Source',
      'official': 'Official',
      'unofficial': 'Unofficial',
      'urgentContact': 'Emergency Contact',
      'reportCrime': 'Report a Crime',
      'recentIncidents': 'Recent Incidents',
      'analytics': 'Analytics',
      'aboutProject': 'About Project',
      'signIn': 'Sign in with Google',
      'signOut': 'Sign Out',
      'addMarker': 'Add Marker',
      'selectCrimeType': 'Select crime type',
      'addressMethod': 'Address entry method',
      'manualAddress': 'Enter address manually',
      'mapAddress': 'Select on map',
      'add': 'Add',
      'cancel': 'Cancel',
      'addressPlaceholder': 'Address',
      'datePlaceholder': 'Incident date',
      'descriptionPlaceholder': 'Incident description',
      'addressNotFound': 'Address not found',
      'markerAdded': 'Marker successfully added!',
      'markerAddError': 'An error occurred while adding the marker. Please try again.',
      'selectCrimeTypePrompt': 'Please select a crime type!',
      'specifyAddress': 'Please specify an address or select a location on the map!',
      'specifyDate': 'Please specify the incident date!',
      'specifyDescription': 'Please add an incident description!',
      'deleteMarker': 'Delete marker',
      'confirmDelete': 'Delete this marker?',
      'markerDeleted': 'Marker deleted',
      'deleteError': 'Deletion error',
      'loginRequired': 'Please sign in with Google',
      'geolocationNotSupported': 'Geolocation is not supported',
      'outOfBounds': 'You are outside the bounds',
      'geolocationError': 'Geolocation error',
      'loadError': 'Failed to load markers',
      'language': 'Language',
      'mapLanguage': 'en',
      'toggleToHeatmap': "Heat Map",
      'toggleToMarkers': "Markers",
      'myLocation': "My Location"
    },
    
    // Кыргызский
    'ky': {
      'crimeType': 'Кылмыш түрү',
      'allTypes': 'Бардык түрлөр',
      'theft': 'Уурулук',
      'violence': 'Зомбулук',
      'fraud': 'Алдамчылык',
      'robbery': 'Грабеж',
      'banditry': 'Разбой',
      'vehicleTheft': 'Угон транспортного средства',
      'vandalism': 'Вандализм',
      'drugTrafficking': 'Наркоторговля',
      'hooliganism': 'Хулиганство',
      'roadAccident': 'ДТП',
      'period': 'Мезгил',
      'source': 'Булак',
      'official': 'Расмий',
      'unofficial': 'Расмий эмес',
      'urgentContact': 'Шашылыш байланыш',
      'reportCrime': 'Кылмыш жөнүндө билдирүү',
      'recentIncidents': 'Акыркы окуялар',
      'analytics': 'Аналитика',
      'aboutProject': 'Долбоор жөнүндө',
      'signIn': 'Google аркылуу кирүү',
      'signOut': 'Чыгуу',
      'addMarker': 'Белги кошуу',
      'selectCrimeType': 'Кылмыш түрүн тандаңыз',
      'addressMethod': 'Дарек көрсөтүү ыкмасы',
      'manualAddress': 'Дарекди кол менен жазуу',
      'mapAddress': 'Картада көрсөтүү',
      'add': 'Кошуу',
      'cancel': 'Жокко чыгаруу',
      'addressPlaceholder': 'Дарек',
      'datePlaceholder': 'Окуя күнү',
      'descriptionPlaceholder': 'Окуянын сүрөттөмөсү',
      'addressNotFound': 'Дарек табылган жок',
      'markerAdded': 'Белги ийгиликтүү кошулду!',
      'markerAddError': 'Белги кошууда ката кетти. Кайталап көрүңүз.',
      'selectCrimeTypePrompt': 'Кылмыш түрүн тандаңыз!',
      'specifyAddress': 'Дарек көрсөтүңүз же картада жайгашкан жерди тандаңыз!',
      'specifyDate': 'Окуя күнүн көрсөтүңүз!',
      'specifyDescription': 'Окуя сүрөттөмөсүн кошуңуз!',
      'deleteMarker': 'Белгини жок кылуу',
      'confirmDelete': 'Белгини жок кылууну каалайсызбы?',
      'markerDeleted': 'Белги жок кылынды',
      'deleteError': 'Жок кылууда ката',
      'loginRequired': 'Google аркылуу кириңиз',
      'geolocationNotSupported': 'Геолокация колдоого алынбайт',
      'outOfBounds': 'Сиз чек арадан тышкары жердесиз',
      'geolocationError': 'Геолокация катасы',
      'loadError': 'Белгилерди жүктөө мүмкүн эмес',
      'language': 'Тил',
      'mapLanguage': 'ky',
      'toggleToHeatmap': "Жылуулук картасы",
      'toggleToMarkers': "Белгилер",
      'myLocation': "Менин жайгашкан жерим"
    }
  };

  // Текущий язык
  let currentLanguage = 'ru';

  // Функция перевода интерфейса
  function translateUI(lang) {
    // Устанавливаем атрибут lang для html
    document.documentElement.lang = lang;
    
    // Переводим все элементы с атрибутом data-lang
    const elements = document.querySelectorAll('[data-lang]');
    elements.forEach(el => {
      const key = el.getAttribute('data-lang');
      if (translations[lang][key]) {
        el.textContent = translations[lang][key];
      }
    });
    
    // Переводим плейсхолдеры
    const placeholders = document.querySelectorAll('[data-lang-placeholder]');
    placeholders.forEach(el => {
      const key = el.getAttribute('data-lang-placeholder');
      if (translations[lang][key]) {
        el.placeholder = translations[lang][key];
      }

      const languageLabels = document.querySelectorAll('[data-lang="language"]');
  languageLabels.forEach(label => {
    label.textContent = translations[lang]['language'];
  });
    });
    
    // Обновляем опции в селектах
    const selects = document.querySelectorAll('select');
    selects.forEach(select => {
      Array.from(select.options).forEach(option => {
        const key = option.getAttribute('data-lang');
        if (key && translations[lang][key]) {
          option.textContent = translations[lang][key];
        }
      });
    });
    
    // Обновляем заголовок страницы
    document.title = lang === 'ru' ? 'BeSafe - Карта преступлений' : 
                    lang === 'en' ? 'BeSafe - Crime Map' : 
                    'BeSafe - Кылмыш картасы';
  }

  // Функция смены языка
  function changeLanguage(lang) {
    currentLanguage = lang;
    document.getElementById('languageSelect').value = lang;
    document.getElementById('mobileLanguageSelect').value = lang;
    translateUI(lang);
    
    // Обновляем текст кнопки тепловой карты мгновенно при смене языка
    if (heatmapActive) {
      document.getElementById('toggleHeatmap').textContent = translations[currentLanguage]['toggleToMarkers'];
    } else {
      document.getElementById('toggleHeatmap').textContent = translations[currentLanguage]['toggleToHeatmap'];
    }
    
    // Сохраняем выбор пользователя
    localStorage.setItem('besafeLanguage', lang);
    
    // Перезагрузка карты с новым языком
    if (map) {
      // Сохраняем текущий центр и зум
      const center = map.getCenter();
      const zoom = map.getZoom();
      
      // Удаляем старый тайловый слой
      map.eachLayer(layer => {
        if (layer instanceof L.TileLayer) {
          map.removeLayer(layer);
        }
      });
      
      // Добавляем новый тайловый слой с соответствующим языком
      const tileLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '© OpenStreetMap contributors'
      });
      tileLayer.addTo(map);
      
      // Восстанавливаем центр и зум
      map.setView(center, zoom);
      
      // Перерисовываем маркеры с новыми переводами
      refreshMarkers();
    }
  }

  function getCrimeTypeInCurrentLanguage(englishType) {
    return translations[currentLanguage][englishType] || englishType;
  }

  // Обновление маркеров при смене языка
  function refreshMarkers() {
    markers.forEach(({ marker, info, id }) => {
      let html = `<strong>${translations[currentLanguage]['crimeType']}:</strong> ${getCrimeTypeInCurrentLanguage(info.crimeType)}<br>
                <strong>${translations[currentLanguage]['addressPlaceholder']}:</strong> ${info.address}<br>
                <strong>${translations[currentLanguage]['datePlaceholder']}:</strong> ${info.date}<br>
                <strong>${translations[currentLanguage]['descriptionPlaceholder']}:</strong> ${info.description}<br>`;
      
      if (currentUser && info.userId === currentUser.email) {
        html += `<button class="delete-btn" data-id="${id}">${translations[currentLanguage]['deleteMarker']}</button>`;
      }
      
      marker.bindPopup(html);
      marker.on('popupopen', () => {
        const btn = document.querySelector(`.delete-btn[data-id="${id}"]`);
        if (btn) btn.onclick = () => deleteMarker(id);
      });
    });
  }

  async function getAddressFromCoords(lat, lng) {
    const response = await fetch(
      `https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${lat}&lon=${lng}&accept-language=${currentLanguage}`
    );
    const data = await response.json();
    return formatAddress(data);
  }

  // Firebase Config
  const firebaseConfig = {
    apiKey: "AIzaSyDgKbBuRmMxVjdC-CM2W-MssfG_kQM1-qo",
    authDomain: "besafe-7bf08.firebaseapp.com",
    projectId: "besafe-7bf08",
    storageBucket: "besafe-7bf08.firebasestorage.app",
    messagingSenderId: "155959634151",
    appId: "1:155959634151:web:ecfadb36b522b95da35a42"
  };

  // Initialize Firebase
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();

  // Global state
  let isAuthenticated = false;
  let currentUser = null;
  let markers = [];               // { marker, info, id }
  let locationMarker = null;
  let selectedLatLng = null;
  let selectedAddress = '';
  let chooseLocationMap = null;
  let chooseLocationMarker = null;
  let debounceTimeout;

  // Глобальная переменная для фильтрации по времени
  let recentTimeFilter = 'all';

  // Глобальные переменные для тепловой карты
  let heatmapActive = false;
  let heatLayer = null;

  // Bishkek bounds
  const bishkekBounds = L.latLngBounds([42.51, 74.25], [43.22, 74.95]);

  // Main map init
  const map = L.map('map', {
    center: [42.8746, 74.5698],
    zoom: 13,
    minZoom: 10,
    maxZoom: 18,
    maxBounds: bishkekBounds,
    maxBoundsViscosity: 1.0
  });
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '© OpenStreetMap contributors'
  }).addTo(map);

  // Modal helpers
  function showModal(id) {
    document.getElementById(id).style.display = 'block';
    document.getElementById('modalOverlay').style.display = 'block';
  }
  
  function hideModal(id) {
    document.getElementById(id).style.display = 'none';
    document.getElementById('modalOverlay').style.display = 'none';
    if (id === 'addMarkerModal') {
      document.getElementById('chooseLocationMap').style.display = 'none';
      document.getElementById('addressSuggestions').style.display = 'none';
    }
  }

  // Address formatting
  function formatAddress(data) {
    if (data.address) {
      const parts = [];
      if (data.address.road) parts.push(data.address.road);
      if (data.address.house_number) parts.push(data.address.house_number);
      if (data.address.suburb) parts.push(data.address.suburb);
      return parts.join(', ') || translations[currentLanguage]['addressNotFound'];
    }
    return data.display_name ? data.display_name.split(',').slice(0,3).join(', ') 
           : translations[currentLanguage]['addressNotFound'];
  }

  // Geocode address
  async function geocodeAddress(address) {
    const res = await fetch(
      `https://nominatim.openstreetmap.org/search?format=jsonv2&q=${encodeURIComponent(address)}&accept-language=${currentLanguage}`
    );
    const data = await res.json();
    if (data && data.length) {
      return { 
        lat: +data[0].lat, 
        lng: +data[0].lon, 
        formattedAddress: formatAddress(data[0]) 
      };
    }
    throw new Error(translations[currentLanguage]['addressNotFound']);
  }

  // Address suggestions
  async function getAddressSuggestions(q) {
    if (q.length < 3) {
      document.getElementById('addressSuggestions').style.display = 'none';
      return;
    }
    
    try {
      const res = await fetch(
        `https://nominatim.openstreetmap.org/search?format=jsonv2&q=${encodeURIComponent(q)}&accept-language=${currentLanguage}&viewbox=74.25,42.51,74.95,43.22&bounded=1`
      );
      const list = await res.json();
      
      const container = document.getElementById('addressSuggestions');
      container.innerHTML = '';
      
      list.forEach(item => {
        const d = document.createElement('div');
        d.className = 'address-suggestion';
        d.textContent = formatAddress(item);
        d.onclick = () => {
          document.getElementById('address').value = formatAddress(item);
          selectedLatLng = { lat: item.lat, lng: item.lon };
          container.style.display = 'none';
        };
        container.appendChild(d);
      });
      
      container.style.display = list.length ? 'block' : 'none';
    } catch (e) {
      console.error(translations[currentLanguage]['loadError'], e);
    }
  }

  // Добавляем функцию для генерации цветной иконки метки
  function getMarkerIcon(crimeType) {
    const colors = {
      theft: 'rgba(40, 120, 120, 1)',
      violence: 'rgba(200, 160, 60, 1)',
      fraud: 'rgba(210, 80, 110, 1)',
      robbery: 'rgba(40, 120, 200, 1)',
      banditry: 'rgba(100, 70, 200, 1)',
      vehicleTheft: 'rgba(200, 100, 40, 1)',
      vandalism: 'rgba(150, 150, 150, 1)',
      drugTrafficking: 'rgba(200, 70, 50, 1)',
      hooliganism: 'rgba(100, 180, 100, 1)',
      roadAccident: 'rgba(180, 160, 0, 1)'
    };
    const color = colors[crimeType] || colors.theft;
    return L.divIcon({
      html: `<div style="background-color: ${color}; width: 24px; height: 24px; border-radius: 50%; border: 2px solid white;"></div>`,
      className: '',
      iconSize: [28, 28],
      iconAnchor: [14, 14]
    });
  }

  // В loadMarkers() используем getMarkerIcon для создания метки
  async function loadMarkers() {
    try {
      const snap = await db.collection('markers').get();
      snap.forEach(doc => {
        const d = doc.data();
        // меняем создание метки: добавляем опцию icon
        const mk = L.marker([d.lat, d.lng], { icon: getMarkerIcon(d.crimeType) }).addTo(map);
        let html = `<strong>${translations[currentLanguage]['crimeType']}:</strong> ${getCrimeTypeInCurrentLanguage(d.crimeType)}<br>
                  <strong>${translations[currentLanguage]['addressPlaceholder']}:</strong> ${d.address}<br>
                  <strong>${translations[currentLanguage]['datePlaceholder']}:</strong> ${d.date}<br>
                  <strong>${translations[currentLanguage]['descriptionPlaceholder']}:</strong> ${d.description}<br>`;
        if (currentUser && d.userId === currentUser.email) {
          html += `<button class="delete-btn" data-id="${doc.id}">${translations[currentLanguage]['deleteMarker']}</button>`;
        }
        mk.bindPopup(html);
        markers.push({ marker: mk, info: d, id: doc.id });
        mk.on('popupopen', () => {
          const btn = document.querySelector(`.delete-btn[data-id="${doc.id}"]`);
          if (btn) btn.onclick = () => deleteMarker(doc.id);
        });
      });
    } catch (e) { 
      alert(translations[currentLanguage]['loadError']); 
      console.error(e); 
    }
  }

  // Delete marker
  function deleteMarker(id) {
    if (!confirm(translations[currentLanguage]['confirmDelete'])) return;
    db.collection('markers').doc(id).delete()
      .then(() => {
        const i = markers.findIndex(m => m.id === id);
        if (i > -1) { 
          map.removeLayer(markers[i].marker); 
          markers.splice(i,1); 
        }
        alert(translations[currentLanguage]['markerDeleted']);
      }).catch(err => { 
        alert(translations[currentLanguage]['deleteError']); 
        console.error(err); 
      });
  }

  // Handle add marker button
  function handleAddMarker() {
    if (!isAuthenticated) return alert(translations[currentLanguage]['loginRequired']);
    // Закрыть сайдбар на мобильных при нажатии кнопки "Добавить метку"
    const sidebar = document.querySelector('.sidebar');
    const hamburger = document.querySelector('.hamburger');
    if (sidebar.classList.contains('active')) {
        sidebar.classList.remove('active');
        hamburger.textContent = '☰';
    }
    document.getElementById('date').value = new Date().toISOString().slice(0,10);
    selectedLatLng = null; 
    selectedAddress = '';
    document.getElementById('address').value = '';
    showModal('addMarkerModal');
  }

  // Submit marker form
  document.querySelector('#addMarkerModal form').addEventListener('submit', async e => {
    e.preventDefault();
    
    // Validation
    const crimeType = document.getElementById('crimeType').value;
    if (!crimeType) {
      alert(translations[currentLanguage]['selectCrimeTypePrompt']);
      return;
    }

    // Address handling
    if (!selectedLatLng) {
      const addr = document.getElementById('address').value.trim();
      if (!addr) {
        alert(translations[currentLanguage]['specifyAddress']);
        return;
      }
      try {
        const res = await geocodeAddress(addr);
        selectedLatLng = { lat: res.lat, lng: res.lng };
        document.getElementById('address').value = res.formattedAddress;
      } catch {
        alert(translations[currentLanguage]['addressNotFound']);
        return;
      }
    }

    const date = document.getElementById('date').value;
    if (!date) {
      alert(translations[currentLanguage]['specifyDate']);
      return;
    }

    const description = document.getElementById('description').value.trim();
    if (!description) {
      alert(translations[currentLanguage]['specifyDescription']);
      return;
    }

    // Save marker
    const data = {
      crimeType: crimeType,
      lat: selectedLatLng.lat,
      lng: selectedLatLng.lng,
      address: document.getElementById('address').value,
      date: date,
      description: description,
      userId: currentUser.email,
      timestamp: firebase.firestore.FieldValue.serverTimestamp(),
      source: 'unofficial'
    };
    
    try {
      const docRef = await db.collection('markers').add(data);
      // создаем метку с иконкой согласно типу преступления
      const mk = L.marker([data.lat, data.lng], { icon: getMarkerIcon(data.crimeType) }).addTo(map);
      let html = `<strong>${translations[currentLanguage]['crimeType']}:</strong> ${getCrimeTypeInCurrentLanguage(data.crimeType)}<br>
                <strong>${translations[currentLanguage]['addressPlaceholder']}:</strong> ${data.address}<br>
                <strong>${translations[currentLanguage]['datePlaceholder']}:</strong> ${data.date}<br>
                <strong>${translations[currentLanguage]['descriptionPlaceholder']}:</strong> ${data.description}<br>
                <button class="delete-btn" data-id="${docRef.id}">${translations[currentLanguage]['deleteMarker']}</button>`;
      mk.bindPopup(html);
      markers.push({ marker: mk, info: data, id: docRef.id });
      mk.on('popupopen', () => {
        const btn = document.querySelector(`.delete-btn[data-id="${docRef.id}"]`);
        if (btn) btn.onclick = () => deleteMarker(docRef.id);
      });
      if (heatmapActive && heatLayer) {
        heatLayer.addLatLng([data.lat, data.lng, 0.5]);
      }
      mk.openPopup();
      hideModal('addMarkerModal');
      alert(translations[currentLanguage]['markerAdded']);
    } catch (error) {
      console.error(error);
      alert(translations[currentLanguage]['markerAddError']);
    }
  });

  // Geolocation
  function getCurrentLocation() {
    if (!navigator.geolocation) return alert(translations[currentLanguage]['geolocationNotSupported']);
    const btn = document.querySelector('.geolocation-button');
    btn.style.backgroundColor = '#e6e6e6';
    
    // Используем getCurrentPosition вместо watchPosition
    navigator.geolocation.getCurrentPosition(
        pos => {
            const lat = pos.coords.latitude, 
                  lng = pos.coords.longitude;
            
            if (bishkekBounds.contains([lat, lng])) {
                if (locationMarker) {
                    locationMarker.setLatLng([lat, lng]);
                } else {
                    locationMarker = L.marker([lat, lng], { 
                        icon: L.divIcon({ 
                            className: 'location-marker', 
                            iconSize: [16, 16], 
                            iconAnchor: [8, 8] 
                        }) 
                    }).addTo(map);
                }
                map.setView([lat, lng], 16);
            } else {
                alert(translations[currentLanguage]['outOfBounds']);
            }
            btn.style.backgroundColor = 'white';
        },
        err => {
            btn.style.backgroundColor = 'white';
            alert(translations[currentLanguage]['geolocationError']);
        },
        { enableHighAccuracy: true, maximumAge: 0 }
    );
}

// Добавляем новый обработчик для кнопки заполнения текущего местоположения
function useMyLocationForMarker() {
  if (!navigator.geolocation) {
    alert(translations[currentLanguage]['geolocationNotSupported']);
    return;
  }
  navigator.geolocation.getCurrentPosition(
    async pos => {
      const lat = pos.coords.latitude;
      const lng = pos.coords.longitude;
      if (!bishkekBounds.contains([lat, lng])) {
        alert(translations[currentLanguage]['outOfBounds']);
        return;
      }
      selectedLatLng = { lat, lng };
      try {
        const address = await getAddressFromCoords(lat, lng);
        document.getElementById('address').value = address;
      } catch (err) {
        alert(translations[currentLanguage]['addressNotFound']);
      }
    },
    err => {
      alert(translations[currentLanguage]['geolocationError']);
    },
    { enableHighAccuracy: true, maximumAge: 0 }
  );
}

  // Auth initialization
  function initAuth() {
    const inBtn = document.getElementById('signInButton');
    const outBtn = document.getElementById('signOutButton');
    
    auth.onAuthStateChanged(u => {
      if (u) {
        isAuthenticated = true;
        currentUser = u;
        inBtn.style.display = 'none';
        outBtn.style.display = 'block';
      } else {
        isAuthenticated = false;
        currentUser = null;
        inBtn.style.display = 'block';
        outBtn.style.display = 'none';
      }
    });
    
    inBtn.onclick = () => auth.signInWithPopup(new firebase.auth.GoogleAuthProvider())
      .catch(e => alert(e.message));
    
    outBtn.onclick = () => auth.signOut();
  }

  // Event listeners
  document.getElementById('address').addEventListener('input', () => {
    clearTimeout(debounceTimeout);
    debounceTimeout = setTimeout(() => 
      getAddressSuggestions(document.getElementById('address').value), 300);
  });

  document.getElementById('crimeTypeFilter').addEventListener('change', e => {
    const t = e.target.value;
    markers.forEach(({marker, info}) => 
      (t === 'all' || info.crimeType === t) ? marker.addTo(map) : map.removeLayer(marker));
  });

  [document.getElementById('startDate'), document.getElementById('endDate')].forEach(inp => 
    inp.addEventListener('change', () => {
      const sd = document.getElementById('startDate').value;
      const ed = document.getElementById('endDate').value;
      
      markers.forEach(({marker, info}) => {
        const d = new Date(info.date);
        const ok = (!sd || d >= new Date(sd)) && (!ed || d <= new Date(ed));
        ok ? marker.addTo(map) : map.removeLayer(marker);
      });
    })
  );

  // Location selection handlers
  document.getElementById('mapAddressBtn').addEventListener('click', function() {
    document.getElementById('chooseLocationMap').style.display = 'block';
    
    if (!chooseLocationMap) {
      chooseLocationMap = L.map('chooseLocationMap', {
        center: map.getCenter(),
        zoom: 15
      });
      
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '© OpenStreetMap contributors'
      }).addTo(chooseLocationMap);
      
      chooseLocationMap.on('click', async function(e) {
        selectedLatLng = e.latlng;
        try {
          const address = await getAddressFromCoords(e.latlng.lat, e.latlng.lng);
          document.getElementById('address').value = address;
        } catch {
          alert(translations[currentLanguage]['addressNotFound']);
        }
        
        if (chooseLocationMarker) {
          chooseLocationMarker.setLatLng(e.latlng);
        } else {
          chooseLocationMarker = L.marker(e.latlng).addTo(chooseLocationMap);
        }
      });
    }
  });

  document.getElementById('manualAddressBtn').addEventListener('click', function() {
    document.getElementById('chooseLocationMap').style.display = 'none';
    selectedLatLng = null;
  });

  // Initialization
  window.onload = () => {
    // Load saved language
    const savedLang = localStorage.getItem('besafeLanguage') || 'ru';
    document.getElementById('languageSelect').value = savedLang;
    changeLanguage(savedLang);
    
    // Initialize auth and load markers
    initAuth();
    loadMarkers();
    document.getElementById('useMyLocation').addEventListener('click', useMyLocationForMarker);
  };

  document.querySelector('.hamburger').addEventListener('click', () => {
    const sidebar = document.querySelector('.sidebar');
    const hamburger = document.querySelector('.hamburger');
    
    sidebar.classList.toggle('active');
    
    // Изменяем символ кнопки в зависимости от состояния меню
    if (sidebar.classList.contains('active')) {
      hamburger.textContent = '✕'; // Символ крестика для закрытия
    } else {
      hamburger.textContent = '☰'; // Символ гамбургера для открытия
    }
  });

  document.addEventListener('click', (e) => {
    const sidebar = document.querySelector('.sidebar');
    const hamburger = document.querySelector('.hamburger');
    
    if (!sidebar.contains(e.target)
        && !e.target.closest('.hamburger')
        && !e.target.closest('.leaflet-container')
        && sidebar.classList.contains('active')) {
      sidebar.classList.remove('active');
      hamburger.textContent = '☰'; // Возвращаем символ гамбургера
    }
  });

  // Analytics modal
  function showAnalyticsModal() {
    const sidebar = document.querySelector('.sidebar');
    const hamburger = document.querySelector('.hamburger');
    if (sidebar.classList.contains('active')) {
        sidebar.classList.remove('active');
        hamburger.textContent = '☰';
    }
    showModal('analyticsModal');
    loadAnalytics();
  }

  function hideAnalyticsModal() {
    hideModal('analyticsModal');
  }

  let analyticsChart; // Новая переменная для диаграммы

  async function loadAnalytics() {
    const filterType = document.getElementById('recentFilterSelect').value;
    const timeFilter = document.getElementById('timeFilterSelect').value;
    const listContainer = document.getElementById('incidentList');
    listContainer.innerHTML = '';
    let count = 0;
    // Подсчет инцидентов по типу для диаграммы
    const typeCounts = {theft: 0, violence: 0, fraud: 0, robbery: 0, banditry: 0, vehicleTheft: 0, vandalism: 0, drugTrafficking: 0, hooliganism: 0, roadAccident: 0};
    try {
      const snap = await db.collection('markers').orderBy('timestamp', 'desc').limit(50).get();
      snap.forEach(doc => {
        const d = doc.data();
        const typeMatch = (filterType === 'all' || d.crimeType.toLowerCase() === filterType.toLowerCase());
        let timeMatch = true;
        if (timeFilter !== 'all') {
          const incidentDate = new Date(d.date);
          const now = new Date();
          if (timeFilter === 'today') {
            timeMatch = incidentDate.getFullYear() === now.getFullYear() &&
                        incidentDate.getMonth() === now.getMonth() &&
                        incidentDate.getDate() === now.getDate();
          } else if (timeFilter === 'month') {
            timeMatch = incidentDate.getFullYear() === now.getFullYear() &&
                        incidentDate.getMonth() === now.getMonth();
          } else if (timeFilter === 'year') {
            timeMatch = incidentDate.getFullYear() === now.getFullYear();
          }
        }
        if (typeMatch && timeMatch) {
          const div = document.createElement('div');
          div.style.borderBottom = '1px solid #ddd';
          div.style.padding = '10px';
          div.innerHTML = `<strong>${translations[currentLanguage]['crimeType']}:</strong> ${getCrimeTypeInCurrentLanguage(d.crimeType)}<br>
                           <strong>${translations[currentLanguage]['addressPlaceholder']}:</strong> ${d.address}<br>
                           <strong>${translations[currentLanguage]['datePlaceholder']}:</strong> ${d.date}<br>
                           <strong>${translations[currentLanguage]['descriptionPlaceholder']}:</strong> ${d.description}<br>`;
          listContainer.appendChild(div);
          count++;
          if(d.crimeType.toLowerCase() === 'theft') typeCounts.theft++;
          else if(d.crimeType.toLowerCase() === 'violence') typeCounts.violence++;
          else if(d.crimeType.toLowerCase() === 'fraud') typeCounts.fraud++;
          else if(d.crimeType.toLowerCase() === 'robbery') typeCounts.robbery++;
          else if(d.crimeType.toLowerCase() === 'banditry') typeCounts.banditry++;
          else if(d.crimeType.toLowerCase() === 'vehicletheft') typeCounts.vehicleTheft++;
          else if(d.crimeType.toLowerCase() === 'vandalism') typeCounts.vandalism++;
          else if(d.crimeType.toLowerCase() === 'drugtrafficking') typeCounts.drugTrafficking++;
          else if(d.crimeType.toLowerCase() === 'hooliganism') typeCounts.hooliganism++;
          else if(d.crimeType.toLowerCase() === 'roadaccident') typeCounts.roadAccident++;
        }
      });
      document.getElementById('incidentCount').textContent = `Всего: ${count}`;

      // Обновление диаграммы
      const ctx = document.getElementById('analyticsChart').getContext('2d');
      if (analyticsChart) {
        analyticsChart.data.datasets[0].data = [
          typeCounts.theft, typeCounts.violence, typeCounts.fraud,
          typeCounts.robbery, typeCounts.banditry, typeCounts.vehicleTheft,
          typeCounts.vandalism, typeCounts.drugTrafficking, typeCounts.hooliganism,
          typeCounts.roadAccident
        ];
        analyticsChart.update();
      } else {
        analyticsChart = new Chart(ctx, {
          type: 'bar',
          data: {
            labels: ['Кража', 'Насилие', 'Мошенничество', 'Грабеж', 'Разбой', 'Угон транспортного средства', 'Вандализм', 'Наркоторговля', 'Хулиганство', 'ДТП'],
            datasets: [{
              label: 'Количество инцидентов',
              data: [
                typeCounts.theft, typeCounts.violence, typeCounts.fraud,
                typeCounts.robbery, typeCounts.banditry, typeCounts.vehicleTheft,
                typeCounts.vandalism, typeCounts.drugTrafficking, typeCounts.hooliganism,
                typeCounts.roadAccident
              ],
              backgroundColor: [
                'rgba(40, 120, 120, 0.2)',
                'rgba(200, 160, 60, 0.2)',
                'rgba(210, 80, 110, 0.2)',
                'rgba(40, 120, 200, 0.2)',
                'rgba(100, 70, 200, 0.2)',
                'rgba(200, 100, 40, 0.2)',
                'rgba(150, 150, 150, 0.2)',
                'rgba(200, 70, 50, 0.2)',
                'rgba(100, 180, 100, 0.2)',
                'rgba(180, 160, 0, 0.2)'
              ],
              borderColor: [
                'rgba(40, 120, 120, 1)',
                'rgba(200, 160, 60, 1)',
                'rgba(210, 80, 110, 1)',
                'rgba(40, 120, 200, 1)',
                'rgba(100, 70, 200, 1)',
                'rgba(200, 100, 40, 1)',
                'rgba(150, 150, 150, 1)',
                'rgba(200, 70, 50, 1)',
                'rgba(100, 180, 100, 1)',
                'rgba(180, 160, 0, 1)'
              ],
              borderWidth: 1
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              y: {
                beginAtZero: true,
                ticks: {
                  stepSize: 1, // only integer steps
                  callback: function(value) {
                    return Math.floor(value) === value ? value : null;
                  }
                }
              }
            }
          }
        });
      }
    } catch (e) {
      console.error(translations[currentLanguage]['loadError'], e);
    }
  }

  document.getElementById('recentFilterSelect').addEventListener('change', loadAnalytics);
  document.getElementById('timeFilterSelect').addEventListener('change', loadAnalytics);

  // Функция переключения между режимами: маркеры ⇔ тепловая карта
function toggleHeatmap() {
  if (!heatmapActive) {
    // Собираем координаты из существующих маркеров
    const heatPoints = markers.map(item => {
      const latLng = item.marker.getLatLng();
      return [latLng.lat, latLng.lng, 0.5]; 
    });

    if (heatPoints.length === 0) {
      alert(translations[currentLanguage]['loadError']);
      return;
    }

    heatLayer = L.heatLayer(heatPoints, {
      radius: 35, // Увеличенный радиус для лучшей видимости
      blur: 25,
      minOpacity: 0.5,
      gradient: {0.4: 'blue', 0.65: 'lime', 1: 'red'}
    }).addTo(map);

    // Скрываем маркеры
    markers.forEach(({ marker }) => map.removeLayer(marker));
    heatmapActive = true;
    document.getElementById('toggleHeatmap').textContent = translations[currentLanguage]['toggleToMarkers'];
  } else {
    // Удаляем тепловую карту и показываем маркеры
    map.removeLayer(heatLayer);
    markers.forEach(({ marker }) => marker.addTo(map));
    heatmapActive = false;
    document.getElementById('toggleHeatmap').textContent = translations[currentLanguage]['toggleToHeatmap'];
  }
}
  // Добавляем обработчик клика для кнопки переключения
  document.getElementById('toggleHeatmap').addEventListener('click', toggleHeatmap);
</script>
</body>
</html>